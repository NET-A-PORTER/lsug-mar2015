<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=1024" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>NET-A-PORTER impress.js template</title>
    
    <meta name="description" content="Let's learn about all those confusing terms used by the Scala and function programming community" />
    <meta name="author" content="Ian Forsey" />

    <link href="css/nap-slides.css" rel="stylesheet" />
    <link href="css/idea.css" rel="stylesheet" />

    <script type="text/javascript" src="js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body class="impress-not-supported">

<!--
    Fallback message for clients that do not support impress.js
-->
<div class="fallback-message">
    <p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
    <p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
</div>

<div id="impress">
    
    <section class="step" data-x="0" data-y="0" style="text-align: center">
        <h2 class="group-logo">
            <span class="the">THE</span><br/>NET-A-PORTER<br/>GROUP
        </h2>
        <h1><em>Product API</em>: lessons learned</h1>
        <h3>Scala, Akka and Spray</h3>
    </section>

    <section class="step" data-x="1500" data-y="0">
        <img src="./images/nap-listing.png" width="900" />
    </section>

    <section class="step" data-x="3000" data-y="0">
        <img src="./images/nap-details.png" width="900" />
    </section>

    <section class="step" data-x="4500" data-y="0">
        <img src="./images/ton-listing.png" width="900" />
    </section>

    <section class="step" data-x="6000" data-y="0">
        <img src="./images/mrp-listing.png" width="900" />
    </section>

    <div class="step" data-x="7500" data-y="0">
        <h2>Scala at NET-A-PORTER</h2>
        <ul>
            <li>First Scala commit: March 2011</li>
            <li>Today</li>
            <ul>
                <li>15 production projects</li>
                <li>across 8 teams</li>
                <li>Workshop 80+ attendees</li>
            </ul>
        </ul>
    </div>

    <section class="step" data-x="9000" data-y="0">
        <br />
        <br />
        <img src="./images/scala-workshop.jpg" width="900" />
    </section>    

    <div class="step" data-x="10500" data-y="0">
        <h2>Listing Endpoint</h2>
        <pre><code class="bash">curl "/product/summaries?business=NAP
                        &amp;categoryIds=2
                        &amp;country=GB
                        &amp;lang=en
                        &amp;limit=60
                        &amp;offset=0"
        </code></pre>
    </div>

    <div class="step" data-x="12000" data-y="0">
        <h2>Product API</h2>
        <ul>
            <li>Scala, Akka, Spray</li>
            <li>All three websites</li>
            <li>Website and mobile apps</li>
            <li>Product Listing and Details pages</li>
        </ul>
    </div>

    <div class="step" data-x="13500" data-y="0">
        <h2>Listing Endpoint</h2>
        <pre><code class="json">{
  "data": [
    {
      "id": 512693,
      "name": "Piqu√© blazer",
      "price": {
        "divisor": 100,
        "duty": 0,
        "tax": 21750,
        "gross": 130500,
        "net": 108750,
        "currency": "GBP"
      },
      "onSale": false,
      "brand": {
        "id": 472,
        "name": "Balmain"
      },
      "badges": [
        "In_Stock"
      ]
    },

    ...

  "metadata": {
    "categoryFacets": [
      {
        "id": 4,
        "count": 3164,
        "children": [
          {
            "id": 12243,
            "count": 55,
          }
        ]
      },

      ...

    ],

    "saleableStandardSizeFacets": [
      {
        "name": "XS",
        "count": 4534,
        "id": "00003_XS_Clothing",
        "scheme": "Clothing",
        "sort": 3
      },

      ...

    ],

    "colourFacets": [
      {
        "id": 45,
        "count": 21
      },

    ]
  }
}</code></pre>
    </div>

    <section class="step snap-vertical" data-x="13500" data-y="175"></section>

    <section class="step snap-vertical" data-x="13500" data-y="800"></section>

    <section class="step snap-vertical" data-x="13500" data-y="1650"></section>

    <section class="step snap-vertical" data-x="13500" data-y="2500"></section>

    <section class="step snap-vertical" data-x="13500" data-y="3300"></section>

    <div class="step" data-x="15000" data-y="3300">
        <h2>Category Endpoint</h2>
        <pre><code class="scala">curl "/categories?business=MRP
                 &amp;country=GB
                 &amp;lang=en"
        </code></pre>
    </div>

    <div class="step" data-x="16500" data-y="3300">
        <h2>Category Endpoint</h2>
        <pre><code class="json">[
  {
    "name": "Lipstick",
    "urlKey": "Lipstick",
    "id": 11153,
    "sort": 21,
    "parentId": 10154
  }, ...
]</code></pre>
    </div>

    <div class="step" data-x="18000" data-y="3300">
        <h2>Monitoring</h2>
        <div style="text-align: center">
            <img src="./images/spray-metrics-issue.png" width="900"/>
        </div>
    </div>

    <section class="step snap-vertical" data-y="6900" data-x="18000"></section>

    <div class="step" data-x="19500" data-y="6900">
        <h2>Monitoring</h2>
        <div style="text-align: center">
            <img src="./images/spray-metrics-pr.png" width="900"/>
        </div>
    </div>

    <section class="step snap-vertical" data-y="8400" data-x="19500"></section>

    <section class="step snap-vertical" data-y="9900" data-x="19500"></section>

    <section class="step snap-vertical" data-y="10375" data-x="19500"></section>

    <div class="step" data-y="10375" data-x="21000">
        <h2>salad-metrics</h2>
        <pre><code class="scala">trait Service
    extends HttpService
    with MetricsSpraySupport {
  
// Metrics
val factory = MetricsDirectiveFactory()
val metricsActor = factory
  .defaultMetricsActorFactory
  .eventTellAdminActor()

  ...

val brandMetrics = 
  factory.timer("brands").time &amp; 
  factory.counter("brands").all.count

val categoryMetrics = 
  factory.timer("categories").time &amp;
  factory.counter("categories").all.count
  
  ...

def route = sealRoute {
  get {
    withBusiness { business =>
      withCountry { country =>

        path("categories") {
          <span class="codehighlight">categoryMetrics</span> {
            onSuccess(category ? GetAll(...)) {
              case CategoryList(lst) =>
                complete(OK, headers, lst)
              case wtf => unhandledMsg(wtf)
            }
          }
        } ~

        ...

      }
    } ~
    path("admin" / "metrics") {
      metricsPage
    }
  }
}
}</code></pre>
    </div>

    <section class="step snap-vertical" data-y="11080" data-x="21000"></section>

    <section class="step snap-vertical" data-y="11850" data-x="21000"></section>

    <section class="step snap-vertical" data-y="12050" data-x="21000"></section>

    <section class="step snap-vertical" data-y="12650" data-x="21000"></section>

    <div class="step" data-x="22500" data-y="12650">
        <h2>Metrics Page</h2>
        <pre><code class="json">{
  "counters": {
    "categories.exceptions": {
      "count": 4
    },
    "categories.successes": {
      "count": 5410
    }
    ...
  },
  "timers": {
    "categories": {
      "rate_units": "calls/second",
      "count": 5414,
      "duration_units": "seconds",
      "p75": 0.5668252500000001,
      "m1_rate": 1.6975360357310575E-137,
      "mean": 0.4096964552529183,
      "min": 0.024544,
      "p95": 0.7699509999999999,
      "m15_rate": 2.964393875E-314,
      "max": 2.129032,
      "stddev": 0.24082099926935263,
      "m5_rate": 1.4821969375E-313,
      "p99": 1.1494231700000004,
      "p98": 0.9718056399999999,
      "mean_rate": 0.018895050966731587,
      "p50": 0.394811,
      "p999": 2.1185571420000016
    },
    ...
  }
}</code></pre>
    </div>

    <section class="step snap-vertical" data-y="13360" data-x="22500"></section>

    <section class="step snap-vertical" data-y="14100" data-x="22500"></section>

    <div class="step" data-x="24000" data-y="14100">
        <h2>Grafana</h2>
        <div style="text-align: center">
            <br />
            <img src="./images/grafana-metrics.png" width="900"/>
        </div>
    </div>

    <div class="step" data-x="25500" data-y="14100">
        <h2>What next?</h2>
        <ul>
            <li>Less intrusive</li>
            <li>Akka support</li>
            <li>CloudWatch support</li>
        </ul>
    </div>

    <section class="step" data-x="27000" data-y="14100">
        <br />
        <br />
        <img src="./images/kamon-logo.png" width="900" />
    </section>

    <div class="step" data-x="28500" data-y="14100">
        <h2>Kamon</h2>
        <ul>
            <li>Out of the box support</li>
            <ul>
                <li>Akka</li>
                <li>Spray</li>
            </ul>
            <li>AspectJ compile-time weaving</li>
            <li>No custom spray directives!</li>
        </ul>
    </div>

    <div class="step" data-x="30000" data-y="14100">
        <h2>Kamon</h2>
        <ul>
            <li>Graphite, StatsD and Datadog</li>
            <li>Really easy to add more</li>
            <li>CloudWatch!</li>
            <ul>
                <li>Will contribute back soon</li>
            </ul>
        </ul>
    </div>

    <div class="step" data-x="31500" data-y="14100">
        <h2>kamon-cloudwatch</h2>
        <div style="text-align: center">
            <br />
            <img src="./images/kamon-cloudwatch-metrics.png" width="900"/>
        </div>
    </div>

</div>

    <script src="js/impress.js"></script>
    <script src="js/impress-console.js"></script>
    <script>
        impress().init()
        impressConsole().init(css="css/impress-console.css")
    </script>

</body>
</html>
